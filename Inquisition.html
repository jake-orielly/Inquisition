<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <style>
            .hp, .hpMax {
                height: 30px;
                width: 250px;
            }

            .hp {
                background-color: green;
            }

            .hpMax {
                outline: 2px solid black;
            }

            .hpText {
                font-size: 18px;
                font-weight: 900;
                margin-left: 10px;
            }
            
            .red {
                color: red;
            }
            
            .green {
                color: green;
            }

            #combatLogContainer {
                height: 25%;
                overflow-y: scroll;
                outline: 5px solid black;
                padding:5px;
            }

            #battleSection {
                height: 65%;
                outline: 5px solid black;
                position:relative;
            }

            #movesSection {
                height: 25%;
                outline: 5px solid black;
                padding: 0;
            }

            #enemyHPMax {
                float:right;
                margin: 5px;
            }


            .tabMenu {
                overflow: hidden;
                border: 1px solid #ccc;
                background-color: #f1f1f1;
            }

            .tab, .tabButton {
                background-color: inherit;
                float: left;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 14px 16px;
                transition: 0.3s;
                font-size: 17px;
            }

            .tab, .tabButton:hover {
                background-color: #ddd;
            }

            .tab, .tabButton.active {
                background-color: #ccc;
            }

            .tabContent {
                display: none;
                padding: 6px 12px;
                border: 1px solid #ccc;
                border-top: none;
            }

            img {
                max-width:calc(90%);
                max-height:calc(90% - 10px);
                margin:5px;
            }

            #playerImageContainer {
                height:90%;
                position: relative;
                bottom: 35px;
            }

            #playerHPMax {
                position:absolute;
                bottom:0;
                margin: 5px;
            }

            #playerContainer {
                display:inline-block;
                position:absolute;
                bottom:0;
            }

            #enemyContainer {
                display:inline-block;
                float:right;
            }

            #enemyImgContainer {
                height:90%;
                position:relative;
            }

            #enemyHPMax {
                float:right;
            }

            .actionButton, .abilityButton {
                font-size: 24px;
                font-weight: 900;
                cursor: pointer;
                display: table; /*Makes divs size of text (for mousover purposes)*/ 
                margin-right: 15px;
            }
            
            .actionButton::selection, .abilityButton::selection {
                background: rgba(0,0,0,0); /*Makes highlight of text invisible*/
            }
            .actionButton::-moz-selection, .abilityButton::-moz-selection {
                background: rgba(0,0,0,0);
            }

            .actionText {
                position:absolute;
                text-align: center;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-weight: 900;
                font-size: 36;
                text-shadow: 2px 2px 4px black;
                display: none;
                transition: 1s;
                -webkit-transition: 1s;
            }

            .actionTextMove {
                top: 30%;
                left: 50%;
                transform: translate(-30%, -50%);
                transition: 1s;
                -webkit-transition: 1s;
            }
            
            .coolDown {
                color: grey;
                cursor: default;
            }
            
            #buffTable {
                position: absolute;
                margin-left: 3;
                top: 3;
            }
            
            .buffImage {
                width: 50px;
                height: 50px;
                margin: 0px;
                border: solid;
            }
            
            .bigBuffText {
                left:45%;
            }
            
            .buffText {
                left: 65%;
            }
            
            .buffText, .bigBuffText {
                color: red;
                position: absolute;
                top: 5%;
                font-weight: 900;
                text-shadow: 2px 2px 2px black;
                font-size: 24px;
            }
            
            .relative {
                position:relative;
            }
            
            td{
                padding:0;
                font-size: 18px;
            }
        </style>
    </head>

    <body>
        <div id="battleSection">
            <div id="enemyContainer">
                <div class="hpMax" id="enemyHPMax">
                    <div class="hp" id="enemyHP">
                        <div class="hpText" id="enemyHPText">1/1</div>
                    </div>
                </div>
                <div id="enemyImgContainer">
                    <img>
                    <div id="enemyActionText" class="actionText">MISS</div>
                </div>
            </div>
            <div id="playerContainer">
                <div id="playerImageContainer">
                    <img src="art/player.jpg">
                    <div id="playerActionText" class="actionText">MISS</div>
                    <table>
                        <tbody id="buffTable">
                        </tbody>
                    </table>
                </div>
                <div class="hpMax" id="playerHPMax">
                    <div class="hp" id="playerHP">
                        <div class="hpText" id="playerHPText">1/1</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tabMenu">
          <button class="tabLinks tabButton" id="movesButton" onclick="openTab(event, 'movesSection')">Actions</button>
          <button class="tabLinks tabButton" onclick="openCombatLog(event)">Combat Log</button>
        </div>
        <table id = "movesSection" class="tabContent">
            <tr>
                <td><div class="actionButton" onClick="playerTurn()">Attack</div></td>
                <td><div class="abilityButton">Error</div></td>
            </tr>
            <tr>
                <td><div class="actionButton" onClick="toggleAbilities()">Abilities</div></td>
                <td><div class="abilityButton">Error</div></td>
            </tr>
            <tr>
                <td><div class="actionButton">Items</div></td>
                <td><div class="abilityButton" >Error</div></td>
            </tr>
            <tr>
                <td><div class="actionButton" onClick="wait()">Wait</div></td>
            </tr>
        </table>
        <div id="combatLogContainer" class="tabContent">
            <table>
                <tbody id="combatLog">
                </tbody>
            </table>
        </div>
        <script src="weapons.js"></script>
        <script src="enemies.js"></script>
        <script>
            var currEnemy = fallenKnight();
            
            var turn = 0;
            var dead = 0;
            
            var isPlayerTurn = true;
            
            var retaliationBuff = {image:"retaliationBuff",bonus:1,count:0};
            var woundedFuryBuff = {image:"woundedFuryBuff",bonus:1,count:0};
            var flagellateBuff = {image:"flagellateBuff",bonus:5,count:0};
            
            function Ability(charType,name,description,maxCooldown,buff,categories,func) {
                this.charType = charType;
                this.name = name; 
                this.description = description;
                this.maxCooldown = maxCooldown;
                this.cooldown = 0;
                this.buff = buff;
                this.categories = categories;
                this.func = func;
            }
            
            function secondWind(charType) {
                return new Ability(charType,"Second Wind","Regain half your missing health.",5,{},{},secondWindFunc)
            }
            
            function retaliation(charType) {
                return new Ability(charType,"Retaliation","Every time you take damage, you gain bonus attack, which is expended the next time you strike.",0,retaliationBuff,{damageTriggers:retaliationFunc,buffs:{damage:retaliationBuff}},noFunc);
            }
            
            function doubleEdge(charType) {
                return new Ability(charType,"Double Edge","A wild strike that hits both you and your enemy.",1,{},{},doubleEdgeFunc)
            }
            
            function woundedFury(charType) {
                return new Ability(charType,"Wounded Fury","The lower your health, the higher your crit chance.",0,woundedFuryBuff,{hpTriggers:woundedFuryFunc,buffs:{critChance:woundedFuryBuff}},noFunc);
            }
            
            function flagellate(charType) {
                return new Ability(charType, "Flagellate","Lash yourself, increasing the damage of your next attack.",3,flagellateBuff,{buffs:{damage:flagellateBuff}},flagellateFunc);
            }
            
            function noFunc() {
                console.log("Error 2: Bad Ability Function","The lower your health, the higher your crit chance.");
            }
            
            function secondWindFunc() {
                var combatText = "<tr><td>";
                var target;
                var amount;
                if (this.charType == "player")
                    target = player;
                else
                    target = enemy;
                amount = parseInt((target.maxHP - target.hp)/2);
                changeHP(amount,target);
                moveText(this.charType,amount);
                combatText += target.name + " got " + target.possPronoun + " second wind, healing for <span class='green'>" + amount + "</span> hp.";
                combatText += "</td></tr>";
                document.getElementById("combatLog").innerHTML += combatText;
            }
            
            
            var player = createPlayer();
            
            var characters = [player,currEnemy];
            startCombat();
            
            for (var i = 0; i < $(".abilityButton").length; i++) {
                $(".abilityButton")[i].innerHTML = player.abilities[i].name;
                $(".abilityButton")[i].setAttribute("onClick","javascript: triggerAbility(" + i + ");");
            }
            
            $(".abilityButton").hide();
            
            function changeHP(val,target) {
                target.hp += val;
                
                if (target.hp <= 0)
                    endCombat(target);
                
                else {
                    if (val < 0) {
                        for (var i = 0; i < target.damageTriggers.length; i++)
                            target.damageTriggers[i](val);
                    }

                    for (var i = 0; i < target.hpTriggers.length; i++)
                            target.hpTriggers[i]();
                }
                
                updateHP(target);
            }
            
            function endCombat(target) {
                for (var i = 0; i < $(".abilityButton").length; i++)
                    $(".abilityButton")[i].classList.add("coolDown");
                dead = target;
            }
            
            function triggerAbility(given) {
                if (player.abilities[given].cooldown == 0 && !dead) {
                    player.abilities[given].cooldown = player.abilities[given].maxCooldown;
                    $(".abilityButton")[given].classList.add("coolDown");
                    player.abilities[given].func();
                }
            }
            
            function showBuff(buff) {
                console.log(buff);
                if (buff.count < 1) {
                        hideBuff(buff.image);
                }
                else if (!document.getElementById(buff.image)) {
                    var result = "<tr id='" + buff.image + "Row'><td><div class='relative'><img class='buffImage' src=art/" + buff.image + ".jpg >"
                    result += "<p class='buffText' id='" + buff.image + "'>" + buff.count + "</p>";
                    result += "</div></td></tr>";
                    document.getElementById("buffTable").innerHTML += result;
                }
                else { 
                    if(!$("#" + buff.image + "Row").is(":visible"))
                        $("#" + buff.image + "Row").show();
                    document.getElementById(buff.image).innerHTML = buff.count;
                }
                
                if (buff.count > 9)
                    document.getElementById(buff.image).classList = "bigBuffText";
            }
            
            function hideBuff(given) {
                $("#" + given + "Row").hide();
            }
            
            function flagellateFunc() {
                var selfDamage = -3;
                var combatText = "<tr><td>";
                this.buff.count += 1;
                changeHP(selfDamage,player);
                moveText("player",selfDamage);
                combatText += player.name + " flogged " + player.perPronoun + "self, inflicting <span class='red'>" + Math.abs(selfDamage) + "</span> damage, and boosting the damage of " + player.possPronoun + " next attack!";
                combatText += "</td></tr>";
                document.getElementById("combatLog").innerHTML += combatText;
                showBuff(this.buff);
            }
            
            function doubleEdgeFunc() {
                var playerTemp = player.hp;
                var enemyTemp = currEnemy.hp;
                var combatText = "<tr><td>";
                
                makeAttack(player, currEnemy);
                makeAttack(player, player);
                
                combatText += player.name + " " + player.weapon.verb + " recklessly, inflicting "
                
                if (playerTemp == player.hp)
                    combatText += "no "
                else
                    combatText += "<span class='red'>" + (playerTemp - player.hp) + "</span>";
                combatText += " damage to " + player.perPronoun + "self, and "
                
                if (enemyTemp == currEnemy.hp)
                    combatText += "no "
                else 
                    combatText += "<span class='red'>" + (enemyTemp - currEnemy.hp) + "</span>";
                combatText += " damage to " + currEnemy.name + ".";
                
                combatText += "</td></tr>";
                document.getElementById("combatLog").innerHTML += combatText;
            }
            
            function retaliationFunc(val) {
                retaliationBuff.count += val*-1;
                showBuff(retaliationBuff);
            }
            
            function woundedFuryFunc() {
                woundedFuryBuff.count = parseInt(10*(1-(player.hp/player.maxHP)));
                showBuff(woundedFuryBuff);
            }
            
            function startCombat() { 
                for (var i = 0; i < characters.length; i++)
                    updateHP(characters[i]);
                document.getElementById("movesSection").style.display = "block";
                document.getElementById("movesButton").className += " active";
                document.getElementById("enemyImgContainer").getElementsByTagName('img')[0].src = "art/" + currEnemy.image + ".jpg";
            }
            
            function playerTurn() {
                if (isPlayerTurn && !dead) {
                    isPlayerTurn = false;
                    $(".abilityButton").hide();
                    $(".actionButton").css("color","grey");
                    $(".actionButton").css("cursor","default");
                    takeTurn(characters[0],characters[1]);
                    if (!dead) {
                        setTimeout(function(){
                            takeTurn(characters[1],characters[0])
                            setTimeout(function(){
                                isPlayerTurn = true
                                $(".actionButton").css("color","black");
                                $(".actionButton").css("cursor","pointer");
                                playerCooldownTick();
                            },1000);
                        }, 1000);
                    }
                }
            }
            
            function wait() {
                if (isPlayerTurn && !dead) {
                    isPlayerTurn = false;
                    $(".abilityButton").hide();
                    $(".actionButton").css("color","grey");
                    $(".actionButton").css("cursor","default");
                    setTimeout(function(){
                        takeTurn(characters[1],characters[0])
                        setTimeout(function(){
                            isPlayerTurn = true
                            $(".actionButton").css("color","black");
                            $(".actionButton").css("cursor","pointer");
                            playerCooldownTick();
                        },1000);
                    }, 1000);
                }
            }
            
            function playerCooldownTick() {
                for (var i = 0; i < player.abilities.length; i++) {
                    if (player.abilities[i].cooldown > 0)
                        player.abilities[i].cooldown--;
                    if (player.abilities[i].cooldown == 0)
                        $(".abilityButton")[i].classList.remove("coolDown");
                }
            }
            
            function takeTurn(curr, target) {
                var result;
                if (curr == currEnemy)
                    result = currEnemy.makeMove(target);
                else
                    result = "<tr><td>" + makeAttack(curr,target) + "</tr></td>";
                turn++;
                document.getElementById("combatLog").innerHTML += result;
            }
            
            function makeAttack(attacker, defender) {
                var attackResult = calcAttack(attacker,defender);
                var crit = false;
                var critAddon = "";
                var critLogAddon = "dealt";
                
                if (attackResult[1]) {
                    attackResult = attackResult[0];
                    crit = true;
                    critAddon = "<br>CRIT!"
                    critLogAddon = "crit, dealing"
                }
                    
                attackResult = attackResult*-1;
                
                if (attackResult == 0) {
                    moveText(defender.charType,"MISS");
                    return attacker.name.charAt(0).toUpperCase() + attacker.name.slice(1) + " " + attacker.weapon.verb + " " + attacker.possPronoun + " " + attacker.weapon.name + " but missed!";
                }
                else {
                    changeHP(attackResult,defender);
                    moveText(defender.charType,attackResult + critAddon);                    
                    
                    if (defender.hp > 0)
                        return attacker.name.charAt(0).toUpperCase() + attacker.name.slice(1) + " " + attacker.weapon.verb + " " + attacker.possPronoun + " " + attacker.weapon.name + " at " + defender.name + " and " + critLogAddon + " <span class='red'>" + Math.abs(attackResult) + "</span> damage. " + defender.name.charAt(0).toUpperCase() + defender.name.slice(1) + " now has <span class='red'>" + defender.hp + "</span> health."; 
                    else {
                        return attacker.name.charAt(0).toUpperCase() + attacker.name.slice(1) + " " + critLogAddon + " <span class='red'>" + + Math.abs(attackResult) + "</span> damage, and " + attacker.weapon.killVerb + " " + defender.name + " with " + attacker.possPronoun + " " + attacker.weapon.name;
                    }
                }
            }
            
            function calcAttack(attacker,defender) { //Todo add UI to alert player to crit
                var result = 0;
                var attack = attackRoll();
                var critThreshold = 20;
                var curr;
                   
                for (var i = 0; i < player.buffs.critChance.length; i++)
                    critThreshold -= player.buffs.critChance[i].count;
                if (attack + attacker.weapon.getAttribute("attack") +attacker.attack > defender.ac || attack == 20) {
                    result = getDamage(attacker.weapon.getAttribute("damage")[0],attacker.weapon.getAttribute("damage")[1]);
                    if (attacker.buffs.damage)
                        for (var i = 0; i < attacker.buffs.damage.length; i++) {
                            curr = attacker.buffs.damage[i];
                            if(curr.count) {
                                result += curr.count * curr.bonus;
                                curr.count = 0;
                                hideBuff(curr.image);
                            }
                        }
                }
                
                if (attack >= critThreshold) {
                    result = [result * 2,true];
                }
                return result;
            }
            
            function attackRoll() {
                return parseInt(Math.random()*20+1);
            }
            
            function getDamage(x,y) {
                return parseInt(Math.random()*(y-(x-1))+x);
            }
            
            function updateHP(target) {
                if (target.hp/target.maxHP < 0.2)
                    document.getElementById(target.charType + "HP").style.backgroundColor = "red";
                else if (target.hp/target.maxHP < 0.4)
                    document.getElementById(target.charType + "HP").style.backgroundColor = "yellow";
                else
                    document.getElementById(target.charType + "HP").style.backgroundColor = "green";
                if (target.hp < 0) {
                    document.getElementById(target.charType + "HP").style.width = "0px";
                    document.getElementById(target.charType + "HPText").innerHTML = "0/" + target.maxHP;
                }
                else {
                    document.getElementById(target.charType + "HP").style.width = (target.hp/target.maxHP) * 250 + "px";
                    document.getElementById(target.charType + "HPText").innerHTML = "" + target.hp + "/" + target.maxHP;
                }    
            }
            
            function moveText(given,val) {
                var span;
                if (val > 0)
                    span = "<span class='green'>";
                else
                    span = "<span class='red'>";
                document.getElementById(given + "ActionText").innerHTML = span + val + "</span>"; //JQuery .text() doesn't work
                $("#" + given + "ActionText").show();
                $("#" + given + "ActionText").fadeOut(1000,textReset("" + given));
                $("#" + given + "ActionText").addClass("actionTextMove");
            }
            
            function textReset(given) {
                $("#" + given + "ActionText").removeClass("actionTextMove");
            }
            
            function toggleAbilities() {
                if (!dead)
                    $(".abilityButton").toggle();
            }
            
            function openCombatLog(event) {
                openTab(event, 'combatLogContainer');
                document.getElementById("combatLogContainer").scrollTop = document.getElementById("combatLogContainer").scrollHeight;
            }
            
            function openTab(evt, currTab) {
                var i, tabContent, tabLinks;
                tabContent = document.getElementsByClassName("tabContent");
                for (i = 0; i < tabContent.length; i++) {
                    tabContent[i].style.display = "none";
                }
                tabLinks = document.getElementsByClassName("tabLinks");
                for (i = 0; i < tabLinks.length; i++) {
                    tabLinks[i].className = tabLinks[i].className.replace(" active", "");
                }
                document.getElementById(currTab).style.display = "block";
                evt.currentTarget.className += " active";
            }
        </script>
    </body>
</html>